<!DOCTYPE html>
<html id="mainHtml">

<head>
    <meta charset="UTF-8">
    <title>Loans</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: #f5f5f5;
        }

        .navbar {
            background: #667eea;
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
        }

        .navbar button {
            background: white;
            color: #667eea;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }

        .container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 20px;
        }

        .form-card {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        input,
        textarea {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        textarea {
            resize: vertical;
            min-height: 60px;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        table {
            width: 100%;
            background: white;
            border-collapse: collapse;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        th,
        td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid #ddd;
        }

        th {
            background: #667eea;
            color: white;
        }

        .ledger-btn {
            background: #3498db;
            padding: 5px 15px;
            font-size: 14px;
            margin: 2px;
        }

        .paid-row {
            background: #e8f5e9;
            opacity: 0.8;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 3% auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 1000px;
            max-height: 85vh;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .ledger-header {
            background: #667eea;
            color: white;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .ledger-summary {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .summary-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }

        .summary-box h4 {
            color: #667eea;
            margin-bottom: 5px;
        }

        .summary-box p {
            font-size: 24px;
            font-weight: bold;
        }

        .ledger-entry {
            background: white;
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
        }

        .entry-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .entry-type-product {
            border-left: 4px solid #e74c3c;
        }

        .entry-type-payment {
            border-left: 4px solid #27ae60;
        }

        .product-details {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
            margin-top: 10px;
        }

        .payment-status {
            background: #fff3cd;
            padding: 8px 12px;
            border-radius: 5px;
            margin-top: 8px;
            border-left: 3px solid #ffc107;
        }

        .payment-status.fully-paid {
            background: #d4edda;
            border-left-color: #28a745;
        }

        .payment-form {
            background: linear-gradient(135deg, #ffe0b2 0%, #ffcc80 100%);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid #ff9800;
        }

        .payment-form h3 {
            color: #e65100;
            margin-bottom: 15px;
        }

        .payment-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 15px;
        }

        .payment-actions {
            display: flex;
            gap: 10px;
        }

        .pay-btn {
            background: #ff9800;
            flex: 1;
        }

        .full-btn {
            background: #f57c00;
            flex: 1;
        }

        .paid-badge {
            background: #4caf50;
            padding: 5px 15px;
            font-size: 14px;
            cursor: not-allowed;
        }
    </style>
</head>

<body>
    <div class="navbar">
        <h1 id="pageTitle">Loans Management</h1>
        <button onclick="window.location.href='dashboard.html'" id="homeBtn">üè† Dashboard</button>
    </div>

    <div class="container">
        <div class="form-card">
            <h2 id="addLoanTitle">Add New Loan Provider</h2>
            <div class="form-row">
                <input type="text" id="loanPerson" placeholder="Person Name">
                <input type="text" id="loanContact" placeholder="Contact Number">
                <input type="text" id="loanAddress" placeholder="Address">
            </div>
            <textarea id="loanNotes" placeholder="Additional notes (optional)"></textarea>
            <button onclick="addLoan()" style="margin-top: 15px;" id="addBtn">‚ûï Add Loan Provider</button>
        </div>

        <table>
            <thead>
                <tr>
                    <th id="thAction">Actions</th>
                    <th id="thRemaining">Remaining</th>
                    <th id="thPaid">Paid</th>
                    <th id="thTotal">Total</th>
                    <th id="thAddress">Address</th>
                    <th id="thContact">Contact</th>
                    <th id="thName">Name</th>
                    <th>#</th>
                </tr>
            </thead>
            <tbody id="loansBody"></tbody>
        </table>
    </div>

    <div id="ledgerModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeLedger()">&times;</span>
            <div id="ledgerContent"></div>
        </div>
    </div>

    <script>
        let loans = JSON.parse(localStorage.getItem('loans') || '[]');
        let currentLoanId = null;

        const translations = {
            ur: {
                pageTitle: 'ŸÇÿ±ÿ∂€í ⁄©ÿß ŸÜÿ∏ÿßŸÖ',
                homeBtn: 'üè† ⁄à€åÿ¥ ÿ®Ÿàÿ±⁄à',
                addLoanTitle: 'ŸÜ€åÿß ŸÇÿ±ÿ∂ ŸÅÿ±ÿß€ÅŸÖ ⁄©ŸÜŸÜÿØ€Å ÿ¥ÿßŸÖŸÑ ⁄©ÿ±€å⁄∫',
                addBtn: '‚ûï ÿ¥ÿßŸÖŸÑ ⁄©ÿ±€å⁄∫',
                thAction: 'ÿß€å⁄©ÿ¥ŸÜ',
                thRemaining: 'ÿ®ÿßŸÇ€å',
                thPaid: 'ÿßÿØÿß ÿ¥ÿØ€Å',
                thTotal: '⁄©ŸÑ',
                thAddress: 'Ÿæÿ™€Å',
                thContact: 'ÿ±ÿßÿ®ÿ∑€Å',
                thName: 'ŸÜÿßŸÖ'
            },
            en: {
                pageTitle: 'Loans Management',
                homeBtn: 'üè† Dashboard',
                addLoanTitle: 'Add New Loan Provider',
                addBtn: '‚ûï Add Provider',
                thAction: 'Actions',
                thRemaining: 'Remaining',
                thPaid: 'Paid',
                thTotal: 'Total',
                thAddress: 'Address',
                thContact: 'Contact',
                thName: 'Name'
            }
        };

        function applyLanguage() {
            const lang = localStorage.getItem('language') || 'en';
            const t = translations[lang];
            document.getElementById('mainHtml').dir = lang === 'ur' ? 'rtl' : 'ltr';

            document.getElementById('pageTitle').textContent = t.pageTitle;
            document.getElementById('homeBtn').textContent = t.homeBtn;
            document.getElementById('addLoanTitle').textContent = t.addLoanTitle;
            document.getElementById('addBtn').textContent = t.addBtn;
            document.getElementById('thAction').textContent = t.thAction;
            document.getElementById('thRemaining').textContent = t.thRemaining;
            document.getElementById('thPaid').textContent = t.thPaid;
            document.getElementById('thTotal').textContent = t.thTotal;
            document.getElementById('thAddress').textContent = t.thAddress;
            document.getElementById('thContact').textContent = t.thContact;
            document.getElementById('thName').textContent = t.thName;
        }

        function addLoan() {
            const person = document.getElementById('loanPerson').value.trim();
            const contact = document.getElementById('loanContact').value.trim();
            const address = document.getElementById('loanAddress').value.trim();
            const notes = document.getElementById('loanNotes').value.trim();

            if (!person || !contact || !address) {
                alert('Please fill all required fields');
                return false; // Add return false
            }

            const loan = {
                id: Date.now(),
                person,
                contact,
                address,
                notes,
                amount: 0,
                paid: 0,
                ledger: [],
                createdDate: new Date().toISOString()
            };

            loans.push(loan);
            localStorage.setItem('loans', JSON.stringify(loans));

            // Clear immediately
            document.getElementById('loanPerson').value = '';
            document.getElementById('loanContact').value = '';
            document.getElementById('loanAddress').value = '';
            document.getElementById('loanNotes').value = '';

            loadLoans();
            alert('Loan provider added successfully');
            return false;
        }
        function payLoan() {
            const amount = parseFloat(document.getElementById('payAmount').value);
            const date = document.getElementById('payDate').value;

            if (!amount || amount <= 0) {
                alert('Please enter a valid amount!');
                return;
            }

            if (!date) {
                alert('Please select a date!');
                return;
            }

            const loan = loans.find(l => l.id === currentLoanId);
            if (!loan) return;

            const remaining = loan.amount - loan.paid;

            if (amount > remaining) {
                alert('Amount cannot be more than remaining! (ÿ±ŸÇŸÖ ÿ®ÿßŸÇ€å ÿ±ŸÇŸÖ ÿ≥€í ÿ≤€åÿßÿØ€Å ŸÜ€Å€å⁄∫ €ÅŸà ÿ≥⁄©ÿ™€å!)');
                return;
            }

            loan.paid += amount;

            if (!loan.ledger) loan.ledger = [];

            loan.ledger.push({
                id: Date.now(),
                date: new Date(date).toISOString(),
                type: 'payment',
                amount: amount,
                balance: loan.amount - loan.paid
            });

            const unpaidProducts = loan.ledger.filter(e => e.type === 'product' && e.remaining > 0);
            let remainingPayment = amount;

            unpaidProducts.forEach(product => {
                if (remainingPayment > 0) {
                    const payForThis = Math.min(remainingPayment, product.remaining);
                    product.paid = (product.paid || 0) + payForThis;
                    product.remaining -= payForThis;
                    remainingPayment -= payForThis;
                }
            });

            localStorage.setItem('loans', JSON.stringify(loans));

            document.getElementById('payAmount').value = '';
            document.getElementById('payDate').value = '';

            loadLoans();
            viewLedger(currentLoanId);

            if (loan.paid >= loan.amount) {
                alert('‚úì Loan Fully Paid! (ŸÇÿ±ÿ∂€Å ŸÖ⁄©ŸÖŸÑ ÿßÿØÿß!)');
            } else {
                alert(`Payment recorded!\nPaid: ${amount.toLocaleString()} Rs\nRemaining: ${(loan.amount - loan.paid).toLocaleString()} Rs`);
            }
        }

        function payFullAmount() {
            const loan = loans.find(l => l.id === currentLoanId);
            if (!loan) return;

            const remaining = loan.amount - loan.paid;

            if (remaining <= 0) {
                alert('Already fully paid!');
                return;
            }

            document.getElementById('payAmount').value = remaining;
        }

        function viewLedger(id) {
            currentLoanId = id;
            const loan = loans.find(l => l.id === id);
            if (!loan) return;

            const ledger = loan.ledger || [];
            const balance = loan.amount - loan.paid;

            let ledgerHTML = `
                <div class="ledger-header">
                    <h2>üìñ Loan Provider Ledger - ${loan.person}</h2>
                    <p>Contact: ${loan.contact} | Address: ${loan.address}</p>
                </div>

                <div class="ledger-summary">
                    <div class="summary-box">
                        <h4>Total Loan Amount</h4>
                        <p>${loan.amount.toLocaleString()} Rs</p>
                    </div>
                    <div class="summary-box">
                        <h4>Total Paid</h4>
                        <p style="color: #27ae60">${loan.paid.toLocaleString()} Rs</p>
                    </div>
                    <div class="summary-box">
                        <h4>Balance</h4>
                        <p style="color: ${balance > 0 ? '#e74c3c' : '#27ae60'}">
                            ${balance.toLocaleString()} Rs
                            ${balance === 0 ? '<br><small style="color: #4caf50;">‚úì Fully Paid</small>' : ''}
                        </p>
                    </div>
                </div>
            `;

            if (balance > 0) {
                const today = new Date().toISOString().split('T')[0];
                ledgerHTML += `
                    <div class="payment-form">
                        <h3>üí∞ Make Payment</h3>
                        <div class="payment-grid">
                            <div>
                                <label style="font-weight: 600; color: #e65100; display: block; margin-bottom: 5px;">Amount to Pay:</label>
                                <input type="number" id="payAmount" placeholder="Enter amount" min="0" max="${balance}" 
                                       style="width: 100%; padding: 10px; border: 2px solid #ff9800; border-radius: 5px;">
                            </div>
                            <div>
                                <label style="font-weight: 600; color: #e65100; display: block; margin-bottom: 5px;">Payment Date:</label>
                                <input type="date" id="payDate" value="${today}" 
                                       style="width: 100%; padding: 10px; border: 2px solid #ff9800; border-radius: 5px;">
                            </div>
                        </div>
                        <div class="payment-actions">
                            <button class="pay-btn" onclick="payLoan()">
                                üíµ Pay Amount
                            </button>
                            <button class="full-btn" onclick="payFullAmount()">
                                üíØ Set Full Amount (${balance.toLocaleString()} Rs)
                            </button>
                        </div>
                    </div>
                `;
            }

            ledgerHTML += '<h3>üìä Transaction History</h3>';

            if (ledger.length === 0) {
                ledgerHTML += '<p style="text-align: center; padding: 20px; color: #999;">No transactions yet</p>';
            } else {
                ledger.slice().reverse().forEach(entry => {
                    let entryClass = 'entry-type-' + entry.type;
                    let typeLabel = entry.type === 'product' ? 'üì¶ Products Purchased on Loan' : 'üí∞ Payment Made';

                    ledgerHTML += `
                        <div class="ledger-entry ${entryClass}">
                            <div class="entry-header">
                                <div>
                                    <strong>${typeLabel}</strong>
                                    <br>
                                    <small>${new Date(entry.date).toLocaleString()}</small>
                                </div>
                                <div style="text-align: right;">
                                    <strong style="font-size: 18px; color: ${entry.type === 'payment' ? '#27ae60' : '#e74c3c'}">
                                        ${entry.type === 'payment' ? '-' : '+'} ${Math.abs(entry.amount).toLocaleString()} Rs
                                    </strong>
                                    <br>
                                    <small>Balance: ${entry.balance.toLocaleString()} Rs</small>
                                </div>
                            </div>
                    `;

                    if (entry.type === 'product') {
                        const productPaid = entry.paid || 0;
                        const productRemaining = entry.remaining || entry.amount;
                        const isFullyPaid = productRemaining === 0;

                        ledgerHTML += `
                            <div class="product-details">
                                <strong>üì¶ Product Details:</strong><br>
                                <strong>${entry.productName}</strong> (${entry.productCode})<br>
                                <small>Quantity: <strong>${entry.quantity}</strong> √ó ${entry.pricePerUnit} Rs = <strong>${entry.amount} Rs</strong></small>
                            </div>
                            <div class="payment-status ${isFullyPaid ? 'fully-paid' : ''}">
                                <strong>${isFullyPaid ? '‚úì Fully Paid' : '‚è≥ Partial Payment'}</strong><br>
                                <small>Paid: <strong>${productPaid.toLocaleString()} Rs</strong> | Remaining: <strong>${productRemaining.toLocaleString()} Rs</strong></small>
                            </div>
                        `;
                    }

                    ledgerHTML += '</div>';
                });
            }

            document.getElementById('ledgerContent').innerHTML = ledgerHTML;
            document.getElementById('ledgerModal').style.display = 'block';
        }

        function closeLedger() {
            document.getElementById('ledgerModal').style.display = 'none';
            currentLoanId = null;
        }

        function loadLoans() {
            const tbody = document.getElementById('loansBody');
            tbody.innerHTML = loans.map((l, i) => {
                const remaining = l.amount - l.paid;
                const isPaid = remaining === 0 && l.amount > 0;
                return `
                <tr class="${isPaid ? 'paid-row' : ''}">
                    <td>
                        ${isPaid ?
                        '<button class="paid-badge" disabled>‚úì Paid</button>' : ''
                    }
                        <button class="ledger-btn" onclick="viewLedger(${l.id})">üìñ Ledger</button>
                    </td>
                    <td><strong>${remaining.toLocaleString()}</strong></td>
                    <td style="color: #27ae60;">${l.paid.toLocaleString()}</td>
                    <td><strong>${l.amount.toLocaleString()}</strong></td>
                    <td>${l.address}</td>
                    <td>${l.contact}</td>
                    <td><strong>${l.person}</strong></td>
                    <td>${i + 1}</td>
                </tr>
            `}).join('');
        }

        window.onclick = function (event) {
            const modal = document.getElementById('ledgerModal');
            if (event.target == modal) {
                closeLedger();
            }
        }

        applyLanguage();
        loadLoans();
    </script>
</body>

</html>